<div class="container-fluid">
  <div class="page-header mb-4">
    <h2><i class="bi bi-bar-chart"></i> Reportes Avanzados</h2>
    <p class="text-muted">Genera y analiza reportes detallados del negocio</p>
  </div>

  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'sales'" (click)="activeTab = 'sales'; loadSalesReports()">
        <i class="bi bi-cart-check"></i> Ventas
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'purchases'" (click)="activeTab = 'purchases'; loadPurchasesReports()">
        <i class="bi bi-bag-plus"></i> Compras
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'inventory'" (click)="activeTab = 'inventory'; loadInventoryReports()">
        <i class="bi bi-box-seam"></i> Inventario
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab === 'profit'" (click)="activeTab = 'profit'; loadProfitLossReport()">
        <i class="bi bi-currency-dollar"></i> Rentabilidad
      </button>
    </li>
  </ul>

  <!-- Sales Tab -->
  <div *ngIf="activeTab === 'sales'">
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Fecha Inicio</label>
            <input type="date" class="form-control" [(ngModel)]="filters.startDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Fecha Fin</label>
            <input type="date" class="form-control" [(ngModel)]="filters.endDate">
          </div>
          <div class="col-md-3">
            <label class="form-label">Categoría</label>
            <select class="form-select" [(ngModel)]="filters.categoryId">
              <option [value]="null">Todas</option>
              <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary w-100" (click)="loadSalesReports()">
              <i class="bi bi-search"></i> Generar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4" *ngIf="salesReport">
      <div class="col-md-4">
        <div class="report-card card-sales">
          <h6>Ventas Totales</h6>
          <h3>{{ salesReport.totalSales | currency:'PEN':'symbol':'1.2-2' }}</h3>
          <p>{{ salesReport.totalTransactions }} transacciones</p>
          <button class="btn btn-sm btn-light" (click)="exportSalesReport()">
            <i class="bi bi-download"></i> Exportar
          </button>
        </div>
      </div>
      <div class="col-md-4">
        <div class="report-card card-avg">
          <h6>Ticket Promedio</h6>
          <h3>{{ salesReport.averageTicket | currency:'PEN':'symbol':'1.2-2' }}</h3>
          <p>Por transacción</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="report-card card-period">
          <h6>Período Analizado</h6>
          <h3>{{ getDaysDifference() }}</h3>
          <p>días de análisis</p>
        </div>
      </div>
    </div>

    <div class="card mb-4" *ngIf="salesReport && salesReport.items.length > 0">
      <div class="card-header d-flex justify-content-between">
        <h5 class="mb-0">Detalle de Ventas</h5>
        <span class="badge bg-info">{{ salesReport.items.length }} registros</span>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th style="color:black">ID</th>
                <th style="color:black">Fecha</th>
                <th style="color:black">Cliente</th>
                <th style="color:black">Items</th>
                <th style="color:black" class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of salesReport.items">
                <td>#{{ item.saleId }}</td>
                <td>{{ item.saleDate | date:'dd/MM/yyyy HH:mm' }}</td>
                <td>{{ item.customerName }}</td>
                <td>{{ item.itemsCount }}</td>
                <td class="text-end"><strong>{{ item.total | currency:'PEN':'symbol':'1.2-2' }}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="card" *ngIf="salesByProduct.length > 0">
      <div class="card-header d-flex justify-content-between">
        <h5 class="mb-0">Ventas por Producto</h5>
        <button class="btn btn-sm btn-outline-primary" (click)="exportSalesByProduct()">
          <i class="bi bi-download"></i> Exportar
        </button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th style="color:black">Producto</th>
                <th style="color:black">Categoría</th>
                <th style="color:black" class="text-center">Cantidad</th>
                <th style="color:black" class="text-end">Ingresos</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of salesByProduct">
                <td><strong>{{ item.productName }}</strong> - {{ item.brand }}</td>
                <td><span class="badge bg-info">{{ item.categoryName }}</span></td>
                <td class="text-center">{{ item.totalQuantitySold }}</td>
                <td class="text-end"><strong>{{ item.totalRevenue | currency:'PEN':'symbol':'1.2-2' }}</strong></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Purchases Tab -->
  <div *ngIf="activeTab === 'purchases'">
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-5">
            <label class="form-label">Fecha Inicio</label>
            <input type="date" class="form-control" [(ngModel)]="filters.startDate">
          </div>
          <div class="col-md-5">
            <label class="form-label">Fecha Fin</label>
            <input type="date" class="form-control" [(ngModel)]="filters.endDate">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-success w-100" (click)="loadPurchasesReports()">Generar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4" *ngIf="purchasesReport">
      <div class="col-md-6">
        <div class="report-card card-purchases">
          <h6>Compras Totales</h6>
          <h3>{{ purchasesReport.totalPurchases | currency:'PEN':'symbol':'1.2-2' }}</h3>
          <p>{{ purchasesReport.totalTransactions }} transacciones</p>
          <button class="btn btn-sm btn-light" (click)="exportPurchasesReport()">
            <i class="bi bi-download"></i> Exportar
          </button>
        </div>
      </div>
      <div class="col-md-6">
        <div class="report-card card-period">
          <h6>Período Analizado</h6>
          <h3>{{ getDaysDifference() }}</h3>
          <p>días de análisis</p>
        </div>
      </div>
    </div>

    <div class="card" *ngIf="purchasesBySupplier.length > 0">
      <div class="card-header d-flex justify-content-between">
        <h5 class="mb-0">Compras por Proveedor</h5>
        <button class="btn btn-sm btn-outline-success" (click)="exportPurchasesBySupplier()">Exportar</button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th style="color:black">Proveedor</th>
                <th style="color:black" class="text-center">Total Compras</th>
                <th style="color:black" class="text-end">Total Gastado</th>
                <th style="color:black">Última Compra</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of purchasesBySupplier">
                <td><strong>{{ item.supplierName }}</strong></td>
                <td class="text-center">{{ item.totalPurchases }}</td>
                <td class="text-end"><strong>{{ item.totalSpent | currency:'PEN':'symbol':'1.2-2' }}</strong></td>
                <td>{{ item.lastPurchaseDate | date:'dd/MM/yyyy' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Tab -->
  <div *ngIf="activeTab === 'inventory'">
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-10">
            <label class="form-label">Categoría</label>
            <select class="form-select" [(ngModel)]="filters.categoryId">
              <option [value]="null">Todas las categorías</option>
              <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-info w-100" (click)="loadInventoryReports()">Generar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4" *ngIf="inventoryValuation">
      <div class="col-md-4">
        <div class="report-card card-inventory">
          <h6>Valor Total Inventario</h6>
          <h3>{{ inventoryValuation.totalValue | currency:'PEN':'symbol':'1.2-2' }}</h3>
          <p>{{ inventoryValuation.totalProducts }} productos</p>
        </div>
      </div>
      <div class="col-md-4">
        <div class="report-card card-units">
          <h6>Unidades Totales</h6>
          <h3>{{ inventoryValuation.totalUnits }}</h3>
          <p>en stock</p>
        </div>
      </div>
      <div class="col-md-4">
        <button class="btn btn-outline-info btn-lg w-100 h-100" (click)="exportInventoryReport()">
          <i class="bi bi-download"></i> Exportar Inventario
        </button>
      </div>
    </div>

    <div class="card" *ngIf="inventoryReport.length > 0">
      <div class="card-header"><h5 class="mb-0">Detalle de Inventario</h5></div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th style="color:black">Producto</th>
                <th style="color:black">Categoría</th>
                <th style="color:black" class="text-center">Stock</th>
                <th style="color:black"class="text-end">Precio Unit.</th>
                <th style="color:black"class="text-end">Valor Total</th>
                <th style="color:black"class="text-center">Rotación</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of inventoryReport">
                <td><strong>{{ item.productName }}</strong> - {{ item.brand }}</td>
                <td><span class="badge bg-info">{{ item.categoryName }}</span></td>
                <td class="text-center">{{ item.currentStock }}</td>
                <td class="text-end">{{ item.unitPrice | currency:'PEN':'symbol':'1.2-2' }}</td>
                <td class="text-end"><strong>{{ item.totalValue | currency:'PEN':'symbol':'1.2-2' }}</strong></td>
                <td class="text-center">
                  <span class="badge" 
                        [class.bg-success]="item.rotationRate > 1" 
                        [class.bg-warning]="item.rotationRate > 0.5 && item.rotationRate <= 1"
                        [class.bg-danger]="item.rotationRate <= 0.5">
                    {{ item.rotationRate | number:'1.2-2' }}x
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Profit/Loss Tab -->
  <div *ngIf="activeTab === 'profit'">
    <div class="card mb-4">
      <div class="card-header"><h5 class="mb-0"><i class="bi bi-funnel"></i> Filtros</h5></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-5">
            <label class="form-label">Fecha Inicio</label>
            <input type="date" class="form-control" [(ngModel)]="filters.startDate">
          </div>
          <div class="col-md-5">
            <label class="form-label">Fecha Fin</label>
            <input type="date" class="form-control" [(ngModel)]="filters.endDate">
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-warning w-100" (click)="loadProfitLossReport()">Generar</button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="profitLossReport">
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="report-card card-income">
            <h6>Ingresos</h6>
            <h3>{{ profitLossReport.totalSales | currency:'PEN':'symbol':'1.2-2' }}</h3>
            <p>{{ profitLossReport.productsSold }} unidades vendidas</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="report-card card-expenses">
            <h6>Egresos</h6>
            <h3>{{ profitLossReport.totalPurchases | currency:'PEN':'symbol':'1.2-2' }}</h3>
            <p>{{ profitLossReport.productsPurchased }} unidades compradas</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="report-card" [class.card-profit]="profitLossReport.grossProfit > 0" 
               [class.card-loss]="profitLossReport.grossProfit < 0">
            <h6>Utilidad Bruta</h6>
            <h3>{{ profitLossReport.grossProfit | currency:'PEN':'symbol':'1.2-2' }}</h3>
            <p>{{ profitLossReport.grossProfit >= 0 ? 'Ganancia' : 'Pérdida' }}</p>
          </div>
        </div>
        <div class="col-md-3">
          <div class="report-card card-margin">
            <h6>Margen de Utilidad</h6>
            <h3>{{ profitLossReport.profitMargin | number:'1.2-2' }}%</h3>
            <p>Sobre ventas</p>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><h5 class="mb-0">Análisis Financiero</h5></div>
        <div class="card-body">
          <div class="alert" 
               [class.alert-success]="profitLossReport.profitMargin > 20"
               [class.alert-info]="profitLossReport.profitMargin > 10 && profitLossReport.profitMargin <= 20"
               [class.alert-warning]="profitLossReport.profitMargin > 0 && profitLossReport.profitMargin <= 10"
               [class.alert-danger]="profitLossReport.profitMargin <= 0">
            <h6 *ngIf="profitLossReport.profitMargin > 20">Excelente rentabilidad</h6>
            <h6 *ngIf="profitLossReport.profitMargin > 10 && profitLossReport.profitMargin <= 20">Buena rentabilidad</h6>
            <h6 *ngIf="profitLossReport.profitMargin > 0 && profitLossReport.profitMargin <= 10">Rentabilidad baja</h6>
            <h6 *ngIf="profitLossReport.profitMargin <= 0">Pérdida operativa</h6>
            <p class="mb-0">Margen: {{ profitLossReport.profitMargin | number:'1.2-2' }}%</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
